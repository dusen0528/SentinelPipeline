# [ISSUE] WebRTC RTSP 스트림의 동적 해상도 변화에 따른 디코딩 및 송출 장애

## 1. 문제 현상 (Symptom)

WebRTC를 통해 중계되는 RTSP 스트림을 입력으로 사용할 때, 초기 연결 시에는 정상 동작하다가 특정 시점 이후 시스템 터미널에 다음과 같은 에러가 반복적으로 발생하며 영상 처리가 불안정해지는 현상이 발견되었습니다.

```text
[swscaler @ 0x7f9610619c00] Slice parameters 0, 540 are invalid
[h264 @ 0x559e2a3b4c00] corrupted macroblock ...
[h264 @ 0x559e2a3b4c00] error while decoding MB ...
```

특히, 입력 스트림이 잠시 끊겼다 재연결되거나 네트워크 환경이 변할 때 해상도가 1280x720에서 960x540 혹은 640x360 등으로 불규칙하게 변경되는 현상이 동반되었습니다.

## 2. 원인 분석 (Root Cause)

### WebRTC의 가변 해상도 특성 (ABR)
일반적인 CCTV(RTSP)와 달리, WebRTC 기반의 스트림은 **ABR(Adaptive Bitrate)** 메커니즘을 사용합니다. 이는 모바일 기기나 네트워크 대역폭의 실시간 변화에 대응하기 위해 해상도와 비트레이트를 동적으로 조절하는 특성입니다.

### 시스템의 정적 구조와 충돌
현재 **SentinelPipeline**의 구조적 한계로 인해 다음의 문제가 발생합니다:

1. **송출기(FFmpegPublisher)의 고정 설정**: 파이프라인 시작 시점의 해상도로 FFmpeg 프로세스가 기동됩니다. `-s 1280x720`과 같이 고정된 인자로 시작된 프로세스에 다른 크기의 프레임 데이터가 유입될 경우, FFmpeg 내부의 `swscaler`가 유효하지 않은 슬라이스 파라미터로 인식하여 에러를 발생시킵니다.
2. **동적 해상도 추적 부재**: 프레임 단위로 처리되는 파이프라인에서 입력 데이터의 크기 변화를 실시간으로 감지하고 이를 퍼블리셔(Infrastructure Layer)에 전달하는 로직이 부족합니다.
3. **재연결 시 해상도 오인**: 재연결 시점의 일시적인 네트워크 불안정으로 인해 카메라가 저해상도(Substream 등)를 먼저 송출하고, 시스템이 이를 최종 해상도로 확정해버리는 문제가 발생합니다.

## 3. 해결하고자 하는 문제 (Objective)

입력 소스의 해상도가 실시간으로 변하는 가변적인 환경에서도 중단 없는 지능형 관제를 수행하기 위해 다음의 목표를 설정합니다:

1. **출력 해상도 정규화 (Canvas Normalization)**
    - 입력 해상도의 변화와 관계없이 최종 출력물은 고정된 해상도(예: 1280x720)를 유지하도록 프레임 리사이즈 로직을 강화합니다.
2. **런타임 해상도 적응형 프로세싱**
    - 입력 프레임의 크기 변화를 실시간 감지하여 AI 추론 모듈(FaceBlur 등)의 입력 사이즈를 동적으로 조절합니다.
3. **송출기 무중단 재설정**
    - 해상도 변경이 감지되었을 때, 송출 세션을 유지하면서도 FFmpeg 인코딩 파라미터를 안전하게 업데이트하는 메커니즘을 구현합니다.

---

## 4. 기술적 대응 방향 (Next Step)

- **Application Layer**: `StreamManager`에서 프레임 읽기 시 `shape` 변화를 감지하는 Watcher 로직 추가
- **Infrastructure Layer**: `FFmpegPublisher`에 고정 캔버스(Letterbox/Padding) 기능을 도입하여 상위 레이어의 변화로부터 FFmpeg 프로세스를 보호
- **Domain Layer**: `StreamConfig`에 목표 출력 해상도를 명시적으로 정의하여 시스템 전체의 정합성 유지

